#!/bin/bash -e

echo Setup in $OPENSHIFT_JBOSSAS6_DIR
cd $OPENSHIFT_JBOSSAS6_DIR

echo Downloading jboss-6.1.0.Final
if [ -f $OPENSHIFT_JBOSSAS6_DIR/../jboss-as-distribution-6.1.0.Final.zip ]; then
  cp $OPENSHIFT_JBOSSAS6_DIR/../jboss-as-distribution-6.1.0.Final.zip $OPENSHIFT_JBOSSAS6_DIR;
else
  wget http://download.jboss.org/jbossas/6.1/jboss-as-distribution-6.1.0.Final.zip;
fi


unzip -q jboss-as-distribution-6.1.0.Final.zip
rm jboss-as-distribution-6.1.0.Final.zip

mv jboss-6.1.0.Final jboss

chmod 755 jboss/bin/run.sh
chmod 755 jboss/bin/shutdown.sh

# server.xml location:
# vars; jboss.web.http.port
# vars; jboss.bind.address
sed -i "s/\${jboss.web.http.port}/$OPENSHIFT_JBOSSAS6_HTTP_PORT/1" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/deploy/jbossweb.sar/server.xml
sed -i "s/\${jboss.bind.address}/$OPENSHIFT_JBOSSAS6_IP/1" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/deploy/jbossweb.sar/server.xml

# Update transaction-jboss-beans
# and put the following line at line 74
sed -i "74a <property name=\"processImplementation\">com.arjuna.ats.internal.arjuna.utils.ExecProcessId</property>" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/deploy/transaction-jboss-beans.xml

# Update binding service beans
sed -i "s/8009/$OPENSHIFT_JBOSSAS6_INTERNAL_AJP_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/1090/$OPENSHIFT_JBOSSAS6_INTERNAL_RMIJRMP_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/1098/$OPENSHIFT_JBOSSAS6_INTERNAL_RMI_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/4446/$OPENSHIFT_JBOSSAS6_INTERNAL_JBOSS_REMOTING_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/5455/$OPENSHIFT_JBOSSAS6_INTERNAL_HORNETQ_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/8083/$OPENSHIFT_JBOSSAS6_INTERNAL_REMOTE_CLASSLOADING_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/4712/$OPENSHIFT_JBOSSAS6_INTERNAL_RECOVERYMANAGER_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/4713/$OPENSHIFT_JBOSSAS6_INTERNAL_TRANSACTIONMANAGER_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml
sed -i "s/4714/$OPENSHIFT_JBOSSAS6_INTERNAL_TRANSACTIONPROCES_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/conf/bindingservice.beans/META-INF/bindings-jboss-beans.xml

# Update ejb3 connectors
sed -i "s/3873/$OPENSHIFT_JBOSSAS6_INTERNAL_EJB3_PORT/g" $OPENSHIFT_JBOSSAS6_DIR/jboss/server/default/deploy/ejb3-connectors-jboss-beans.xml
